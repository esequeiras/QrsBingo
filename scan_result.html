<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scanner QR - Bingo</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f6fb; color:#111; margin:0; padding:18px; }
    .wrap { max-width:900px; margin:0 auto; }
    header { text-align:center; margin-bottom:14px; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 8px 24px rgba(20,30,60,0.06); }
    #reader { width:100%; max-width:640px; height:auto; margin:0 auto; }
    .controls { display:flex; gap:8px; margin-top:12px; justify-content:center; flex-wrap:wrap; }
    button, select { padding:10px 14px; border-radius:8px; border:1px solid #dbeafe; background:#2563eb; color:white; cursor:pointer; font-weight:600; }
    select { background:#fff; color:#111; border:1px solid #d1d5db; font-weight:500; }
    button.ghost { background:#eef2ff; color:#111; border:1px solid #dbeafe; }
    .result { margin-top:16px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    pre { background:#0b1220; color:#e6eef8; padding:12px; border-radius:8px; overflow:auto; max-height:360px; width:100%; }
    .meta { min-width:220px; }
    small { color:#666; }
    .hint { color:#444; font-size:14px; margin-top:8px; text-align:center; }

    /* Popup */
    .popup {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5); display: flex;
      align-items: center; justify-content: center;
      z-index: 999; display: none;
    }
    .popup-content {
      background: #fff; padding: 24px; border-radius: 12px;
      text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      max-width: 300px;
    }
    .popup-content.success { border: 3px solid #16a34a; }
    .popup-content.error { border: 3px solid #dc2626; }
    .popup h2 { margin-top:0; }
    .loading {
      text-align:center; font-size:16px; color:#555;
      margin-top:12px;
    }
    .dots::after {
      content: ''; animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Scanner QR ‚Äî C√°mara</h1>
      <p class="hint">Selecciona la c√°mara y escanea el QR.</p>
    </header>

    <div class="card">
      <div class="controls">
        <select id="cameraSelect">
          <option value="">Seleccionar c√°mara...</option>
        </select>
        <button id="startBtn">Iniciar</button>
        <button id="stopBtn" class="ghost" style="display:none">Detener</button>
      </div>

      <div id="reader"></div>
      <div class="loading" id="loading">üîÑ Levantando servicio<span class="dots"></span></div>

      <div class="result">
        <div style="flex:1">
          <h3>Resultado</h3>
          <pre id="output">‚Äî</pre>
        </div>
        <div class="meta card" style="padding:12px; width:260px;">
          <h4>Estado</h4>
          <small id="lastInfo">Sin escaneos a√∫n</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content" id="popupContent">
      <h2 id="popupTitle"></h2>
      <p id="popupMessage"></p>
      <button onclick="closePopup()">Cerrar</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    const output = document.getElementById('output');
    const lastInfo = document.getElementById('lastInfo');
    const loading = document.getElementById('loading');
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popupContent');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    let html5QrCode = null;
    let scanningLocked = false;
    let serviceReady = false;

    // üéµ Sonidos en base64
    const successSound = new Audio("data:audio/mp3;base64,SUQzAwAAAAAAQ1RTU0QAAA... (truncado) ...");
    const errorSound = new Audio("data:audio/mp3;base64,SUQzAwAAAAAAQ1RTU0QAAA... (truncado) ...");

    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices.length) {
          alert("No se encontraron c√°maras.");
          return;
        }
        cameraSelect.innerHTML = "";
        devices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.label || `C√°mara ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(opt);
        });
      } catch (e) {
        alert("Error obteniendo c√°maras: " + e);
      }
    }

    function decodeQRText(decodedText) {
      try {
        const match = decodedText.match(/[?&]data=([^&]+)/);
        if (!match) return { raw: decodedText, decoded: null };
        const base64data = decodeURIComponent(match[1]);
        const jsonStr = atob(base64data.replace(/-/g, '+').replace(/_/g, '/'));
        const obj = JSON.parse(jsonStr);
        return { raw: decodedText, decoded: obj };
      } catch (e) {
        console.error("Error decodificando:", e);
        return { raw: decodedText, decoded: null };
      }
    }

    async function startCamera() {
      const cameraId = cameraSelect.value;
      if (!cameraId) {
        alert("Selecciona una c√°mara primero.");
        return;
      }

      html5QrCode = new Html5Qrcode("reader");
      try {
        await html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 300 },
          (decodedText) => handleScan(decodedText)
        );
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
      } catch (err) {
        alert("Error al iniciar c√°mara: " + err);
      }
    }

    async function handleScan(decodedText) {
      if (scanningLocked) return;
      scanningLocked = true;

      const { raw, decoded } = decodeQRText(decodedText);
      if (decoded) {
        output.textContent = JSON.stringify(decoded, null, 2);
        await sendToBackend(decoded);
      } else {
        output.textContent = raw;
        scanningLocked = false;
      }
    }

    async function sendToBackend(data) {
      try {
        const response = await fetch("https://qrsbingo.onrender.com/api/scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        serviceReady = true;
        loading.style.display = "none";

        if (!result.ok) {
          playSound("error");
          showPopup("‚ùå QR inv√°lido", result.message, "error");
        } else {
          playSound("success");
          showPopup("‚úÖ V√°lido", `${result.message} ‚Äî Tickets: ${result.tickets}`, "success");
        }

        lastInfo.textContent = `${result.ok ? "‚úÖ" : "‚ùå"} ${result.message} (${new Date().toLocaleTimeString()})`;
      } catch (err) {
        playSound("error");
        showPopup("‚ö†Ô∏è Error", "No se pudo conectar con el servidor.", "error");
        console.error("Error enviando al backend:", err);
      }
    }

    function playSound(type) {
      if (type === "success") successSound.play();
      else errorSound.play();
    }

    function showPopup(title, message, type) {
      popupTitle.textContent = title;
      popupMessage.textContent = message;
      popupContent.className = `popup-content ${type}`;
      popup.style.display = "flex";
    }

    function closePopup() {
      popup.style.display = "none";
      scanningLocked = false;
    }

    async function stopCamera() {
      if (!html5QrCode) return;
      try {
        await html5QrCode.stop();
      } catch {}
      html5QrCode.clear();
      html5QrCode = null;
      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      lastInfo.textContent = "C√°mara detenida";
    }

    startBtn.onclick = startCamera;
    stopBtn.onclick = stopCamera;
    window.onload = loadCameras;
  </script>
</body>
</html>
