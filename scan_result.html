<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scanner QR - Bingo</title>

  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f6fb; margin:0; padding:18px; }
    .wrap { max-width:900px; margin:0 auto; }
    header { text-align:center; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 8px 24px rgba(20,30,60,0.06); }

    #reader { width:100%; max-width:640px; margin:0 auto; }
    .controls { display:flex; gap:8px; justify-content:center; margin-bottom:10px; flex-wrap:wrap; }

    button, select {
      padding:10px 14px; border-radius:8px; border:1px solid #dbeafe;
      font-weight:600; cursor:pointer;
    }
    button { background:#2563eb; color:white; }
    button.ghost { background:#eef2ff; color:#111; }
    select { background:#fff; color:#111; font-weight:500; }

    .result { margin-top:16px; display:flex; gap:12px; flex-wrap:wrap; }
    pre {
      background:#0b1220; color:#e6eef8; padding:12px;
      border-radius:8px; overflow:auto; max-height:360px; width:100%;
    }

    .meta { min-width:240px; }
    small { color:#666; }
    .hint { font-size:14px; text-align:center; margin-top:6px; }

    /* POPUP */
    .popup {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 999;
    }
    .popup-content {
      background:white; padding:24px; border-radius:12px;
      max-width:300px; text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,0.2);
    }
    .popup-content.success { border:3px solid #16a34a; }
    .popup-content.error   { border:3px solid #dc2626; }

    .loading {
      text-align:center; font-size:16px; color:#555; margin-top:12px;
    }

    .dots::after { content:''; animation:dots 1.5s steps(3,end) infinite; }
    @keyframes dots {
      0% { content:''; }
      33% { content:'.'; }
      66% { content:'..'; }
      100%{ content:'...'; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Scanner QR â€” CÃ¡mara</h1>
      <p class="hint">Selecciona la cÃ¡mara y escanea el cÃ³digo QR.</p>
    </header>

    <div class="card">
      <div class="controls">
        <select id="cameraSelect"><option>Seleccionar cÃ¡mara...</option></select>
        <button id="startBtn">Iniciar</button>
        <button id="stopBtn" class="ghost" style="display:none;">Detener</button>
      </div>

      <div id="reader"></div>

      <div class="loading" id="loading">ðŸ”„ Levantando servicio<span class="dots"></span></div>

      <div class="result">
        <div style="flex:1">
          <h3>Resultado</h3>
          <pre id="output">â€”</pre>
        </div>

        <div class="meta card" style="padding:12px">
          <h4>Estado</h4>
          <small id="lastInfo">Sin escaneos aÃºn</small>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP -->
  <div class="popup" id="popup">
    <div class="popup-content" id="popupContent">
      <h2 id="popupTitle"></h2>
      <p id="popupMessage"></p>
      <button onclick="closePopup()">Cerrar</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    const output = document.getElementById('output');
    const lastInfo = document.getElementById('lastInfo');
    const loading = document.getElementById('loading');

    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popupContent');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');

    let html5QrCode = null;
    let scanningLocked = false;
    let serviceReady = false;

    // ðŸŽµ Sonidos (reemplaza los base64 por los tuyos)
    const successSound = new Audio("data:audio/mp3;base64,SUQzAwAAAAAA...");
    const errorSound   = new Audio("data:audio/mp3;base64,SUQzAwAAAAAA...");

    // ðŸš€ Verificar backend al cargar
    async function checkServer() {
      try {
        const r = await fetch("https://qrsbingo.onrender.com/ping");
        const d = await r.json();

        if (d.ok) {
          serviceReady = true;
          loading.innerText = "Servidor listo âœ”";
          loading.style.color = "#16a34a";

          setTimeout(() => loading.style.display = "none", 800);
        } else {
          loading.innerText = "âŒ Servidor no disponible";
        }
      } catch (e) {
        loading.innerText = "âŒ No se pudo conectar a /ping";
        console.error(e);
      }
    }

    // ðŸ“¸ Obtener cÃ¡maras
    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = "";
        devices.forEach(d => {
          let opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.label || "CÃ¡mara";
          cameraSelect.appendChild(opt);
        });
      } catch (e) {
        alert("Error obteniendo cÃ¡maras");
      }
    }

    // â›” No iniciar si backend no estÃ¡ listo
    async function startCamera() {
      if (!serviceReady) {
        alert("El servidor aÃºn no estÃ¡ listo. Espera un momento.");
        return;
      }

      const cameraId = cameraSelect.value;
      if (!cameraId) return alert("Selecciona una cÃ¡mara.");

      html5QrCode = new Html5Qrcode("reader");

      try {
        await html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 300 },
          decodedText => handleScan(decodedText)
        );
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
      } catch (err) {
        alert("Error al iniciar cÃ¡mara: " + err);
      }
    }

    // ðŸ“¦ Decodificar QR
    function decodeQRText(decodedText) {
      try {
        const match = decodedText.match(/[?&]data=([^&]+)/);
        if (!match) return { raw: decodedText, decoded: null };

        const base64data = decodeURIComponent(match[1]);
        const jsonStr = atob(base64data.replace(/-/g, '+').replace(/_/g, '/'));
        return { raw: decodedText, decoded: JSON.parse(jsonStr) };
      } catch {
        return { raw: decodedText, decoded: null };
      }
    }

    // ðŸ” Al detectar un QR
    async function handleScan(decodedText) {
      if (scanningLocked) return;

      scanningLocked = true;

      const { raw, decoded } = decodeQRText(decodedText);
      if (!decoded) {
        output.textContent = raw;
        scanningLocked = false;
        return;
      }

      output.textContent = JSON.stringify(decoded, null, 2);
      await sendToBackend(decoded);
    }

    // ðŸŒ Llamar backend
    async function sendToBackend(data) {
      try {
        const r = await fetch("https://qrsbingo.onrender.com/api/scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await r.json();

        if (!result.ok) {
          playSound("error");
          showPopup("âŒ QR invÃ¡lido", result.message, "error");
        } else {
          playSound("success");
          showPopup("âœ… VÃ¡lido",
            `${result.message} â€” Tickets: ${result.tickets}`,
            "success"
          );
        }

        lastInfo.textContent =
          `${result.ok ? "âœ…" : "âŒ"} ${result.message} (${new Date().toLocaleTimeString()})`;

      } catch (e) {
        playSound("error");
        showPopup("âš ï¸ Error", "No se pudo conectar con el servidor.", "error");
      }
    }

    function playSound(type) {
      if (type === "success") successSound.play();
      else errorSound.play();
    }

    function showPopup(title, msg, type) {
      popupTitle.textContent = title;
      popupMessage.textContent = msg;
      popupContent.className = `popup-content ${type}`;
      popup.style.display = "flex";
    }

    function closePopup() {
      popup.style.display = "none";
      scanningLocked = false;
    }

    async function stopCamera() {
      if (!html5QrCode) return;
      await html5QrCode.stop().catch(()=>{});
      html5QrCode.clear();
      html5QrCode = null;

      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      lastInfo.textContent = "CÃ¡mara detenida";
    }

    startBtn.onclick = startCamera;
    stopBtn.onclick = stopCamera;

    window.onload = () => {
      checkServer();
      loadCameras();
    };
  </script>

</body>
</html>
