<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scanner QR - Bingo</title>

  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f6fb; margin:0; padding:18px; }

    /* Ocultamos la app hasta que el server est√© listo */
    .wrap { max-width:900px; margin:0 auto; display:none; }

    header { text-align:center; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 8px 24px rgba(20,30,60,0.06); }

    #reader { width:100%; max-width:640px; margin:0 auto; }
    .controls { display:flex; gap:8px; justify-content:center; margin-bottom:10px; flex-wrap:wrap; }

    button, select {
      padding:10px 14px; border-radius:8px; border:1px solid #dbeafe;
      font-weight:600; cursor:pointer;
    }
    button { background:#2563eb; color:white; }
    button:disabled { background:#9ca3af; cursor:not-allowed; }
    button.ghost { background:#eef2ff; color:#111; }
    select { background:#fff; color:#111; font-weight:500; }

    .result { margin-top:16px; display:flex; gap:12px; flex-wrap:wrap; }
    pre {
      background:#0b1220; color:#e6eef8; padding:12px;
      border-radius:8px; overflow:auto; max-height:360px; width:100%;
    }

    .meta { min-width:240px; }
    small { color:#666; }
    .hint { font-size:14px; text-align:center; margin-top:6px; }

    /* POPUP */
    .popup {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 999;
    }
    .popup-content {
      background:white; padding:24px; border-radius:12px;
      max-width:320px; text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,0.2);
    }
    .popup-content.success { border:3px solid #16a34a; }
    .popup-content.error   { border:3px solid #dc2626; }

    .loading {
      text-align:center; font-size:16px; color:#555; margin-top:12px;
    }

    .dots::after { content:''; animation:dots 1.5s steps(3,end) infinite; }
    @keyframes dots {
      0% { content:''; }
      33% { content:'.'; }
      66% { content:'..'; }
      100%{ content:'...'; }
    }

    /* Overlay de servidor despertando */
    .server-overlay {
      position:fixed;
      inset:0;
      background:#0b1120;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      z-index:1000;
      text-align:center;
      padding:16px;
    }

    .spinner {
      width:32px;
      height:32px;
      border-radius:50%;
      border:3px solid rgba(255,255,255,0.2);
      border-top-color:#38bdf8;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <!-- Overlay mientras el servidor despierta -->
  <div id="serverOverlay" class="server-overlay">
    <div class="spinner"></div>
    <div>
      <div style="font-size:18px; font-weight:600;">Levantando servicio‚Ä¶</div>
      <div style="font-size:14px; opacity:0.8;">Esto puede tardar unos segundos si el servidor est√° dormido.</div>
    </div>
  </div>

  <div class="wrap" id="appWrapper">
    <header>
      <h1>Scanner QR ‚Äî C√°mara</h1>
      <p class="hint">Selecciona la c√°mara y escanea el c√≥digo QR.</p>
    </header>

    <div class="card">
      <div class="controls">
        <select id="cameraSelect"><option>Seleccionar c√°mara...</option></select>
        <button id="startBtn" disabled>Iniciar</button>
        <button id="stopBtn" class="ghost" style="display:none;">Detener</button>
      </div>

      <div id="reader"></div>

      <div class="loading" id="loading">üîÑ Verificando servidor<span class="dots"></span></div>

      <div class="result">
        <div style="flex:1">
          <h3>Resultado</h3>
          <pre id="output">‚Äî</pre>
        </div>

        <div class="meta card" style="padding:12px">
          <h4>Estado</h4>
          <small id="lastInfo">Sin escaneos a√∫n</small>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP -->
  <div class="popup" id="popup">
    <div class="popup-content" id="popupContent">
      <h2 id="popupTitle"></h2>
      <p id="popupMessage"></p>
      <button onclick="closePopup()">Cerrar</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    const BACKEND_URL = "https://qrsbingo.onrender.com";

    const appWrapper   = document.getElementById('appWrapper');
    const serverOverlay = document.getElementById('serverOverlay');

    const startBtn     = document.getElementById('startBtn');
    const stopBtn      = document.getElementById('stopBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    const output       = document.getElementById('output');
    const lastInfo     = document.getElementById('lastInfo');
    const loading      = document.getElementById('loading');

    const popup        = document.getElementById('popup');
    const popupContent = document.getElementById('popupContent');
    const popupTitle   = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');

    let html5QrCode = null;
    let scanningLocked = false;
    let serviceReady = false;

    // Si quieres usar sonidos, descomenta y pon tus base64:
    // const successSound = new Audio("data:audio/mp3;base64,....");
    // const errorSound   = new Audio("data:audio/mp3;base64,....");

    function playSound(type) {
      // if (type === "success") successSound.play();
      // else errorSound.play();
    }

    // üöÄ Verificar backend al cargar (reintenta hasta que responda)
    async function checkServerOnce() {
      try {
        const r = await fetch(`${BACKEND_URL}/ping`, { cache: "no-store" });
        const d = await r.json();

        if (d.ok) {
          serviceReady = true;
          loading.textContent = "Servidor listo ‚úî";
          loading.style.color = "#16a34a";

          // Mostrar app y ocultar overlay
          appWrapper.style.display = "block";
          serverOverlay.style.display = "none";

          startBtn.disabled = false;
          return true;
        } else {
          loading.textContent = "‚ùå Servidor no disponible";
          return false;
        }
      } catch (e) {
        console.log("Ping fall√≥, reintentando‚Ä¶");
        loading.textContent = "üîÑ Esperando servidor‚Ä¶";
        return false;
      }
    }

    async function checkServerLoop() {
      const ok = await checkServerOnce();
      if (!ok) {
        // Reintenta cada 2 segundos hasta que levante
        setTimeout(checkServerLoop, 2000);
      }
    }

    // üì∏ Obtener c√°maras
    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = "";
        devices.forEach(d => {
          let opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.label || "C√°mara";
          cameraSelect.appendChild(opt);
        });
      } catch (e) {
        alert("Error obteniendo c√°maras");
      }
    }

    // ‚õî No iniciar si backend no est√° listo
    async function startCamera() {
      if (!serviceReady) {
        alert("El servidor a√∫n no est√° listo. Espera un momento.");
        return;
      }

      const cameraId = cameraSelect.value;
      if (!cameraId) {
        alert("Selecciona una c√°mara.");
        return;
      }

      if (html5QrCode) {
        // por si acaso ya hab√≠a una instancia previa
        await stopCamera();
      }

      html5QrCode = new Html5Qrcode("reader");

      try {
        await html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: 300,
            // intentar ayudar al enfoque / calidad
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true
            }
          },
          decodedText => handleScan(decodedText),
          errorMessage => {
            // errores de escaneo continuos, no hacemos nada
            // console.log("Scan error", errorMessage);
          }
        );
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        lastInfo.textContent = "C√°mara lista, esperando QR‚Ä¶";
      } catch (err) {
        alert("Error al iniciar c√°mara: " + err);
      }
    }

    // üì¶ Decodificar la parte ?data= del QR
    function decodeQRText(decodedText) {
      try {
        const match = decodedText.match(/[?&]data=([^&]+)/);
        if (!match) return { raw: decodedText, decoded: null };

        const base64data = decodeURIComponent(match[1]);
        const jsonStr = atob(base64data.replace(/-/g, '+').replace(/_/g, '/'));
        return { raw: decodedText, decoded: JSON.parse(jsonStr) };
      } catch (e) {
        console.error("Error decodificando QR:", e);
        return { raw: decodedText, decoded: null };
      }
    }

    // üîç Al detectar un QR
    async function handleScan(decodedText) {
      if (scanningLocked) return;

      scanningLocked = true;

      const { raw, decoded } = decodeQRText(decodedText);
      if (!decoded) {
        output.textContent = raw;
        scanningLocked = false;
        return;
      }

      output.textContent = JSON.stringify(decoded, null, 2);
      await sendToBackend(decoded);
    }

    // üåê Llamar backend
    async function sendToBackend(data) {
      try {
        const r = await fetch(`${BACKEND_URL}/api/scan`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await r.json();

        if (!result.ok) {
          playSound("error");
          showPopup("‚ùå QR inv√°lido", result.message, "error");
        } else {
          playSound("success");
          showPopup("‚úÖ V√°lido",
            `${result.message} ‚Äî Tickets: ${result.tickets}`,
            "success"
          );
        }

        lastInfo.textContent =
          `${result.ok ? "‚úÖ" : "‚ùå"} ${result.message} (${new Date().toLocaleTimeString()})`;

      } catch (e) {
        playSound("error");
        showPopup("‚ö†Ô∏è Error", "No se pudo conectar con el servidor.", "error");
        console.error("Error backend:", e);
      }
    }

    function showPopup(title, msg, type) {
      popupTitle.textContent = title;
      popupMessage.textContent = msg;
      popupContent.className = `popup-content ${type}`;
      popup.style.display = "flex";
    }

    function closePopup() {
      popup.style.display = "none";
      scanningLocked = false; // aqu√≠ volvemos a permitir escanear otro QR
      lastInfo.textContent = "Listo para escanear otro QR.";
    }

    async function stopCamera() {
      if (!html5QrCode) return;
      try {
        await html5QrCode.stop();
      } catch (e) {}
      html5QrCode.clear();
      html5QrCode = null;

      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      lastInfo.textContent = "C√°mara detenida";
    }

    startBtn.onclick = startCamera;
    stopBtn.onclick = stopCamera;

    window.onload = () => {
      checkServerLoop(); // empieza a pinguear al backend
      loadCameras();     // prepara la lista de c√°maras
    };
  </script>

</body>
</html>
