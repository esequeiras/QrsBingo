<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scanner QR - Bingo</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f6fb; color:#111; margin:0; padding:18px; }
    .wrap { max-width:900px; margin:0 auto; }
    header { text-align:center; margin-bottom:14px; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 8px 24px rgba(20,30,60,0.06); }
    #reader { width:100%; max-width:640px; height:auto; margin:0 auto; }
    .controls { display:flex; gap:8px; margin-top:12px; justify-content:center; flex-wrap:wrap; }
    button, select { padding:10px 14px; border-radius:8px; border:1px solid #dbeafe; background:#2563eb; color:white; cursor:pointer; font-weight:600; }
    select { background:#fff; color:#111; border:1px solid #d1d5db; font-weight:500; }
    button.ghost { background:#eef2ff; color:#111; border:1px solid #dbeafe; }
    .result { margin-top:16px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    pre { background:#0b1220; color:#e6eef8; padding:12px; border-radius:8px; overflow:auto; max-height:360px; width:100%; }
    .meta { min-width:220px; }
    small { color:#666; }
    .hint { color:#444; font-size:14px; margin-top:8px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Scanner QR — Cámara</h1>
      <p class="hint">Selecciona la cámara y escanea el QR.</p>
    </header>

    <div class="card">
      <div class="controls">
        <select id="cameraSelect">
          <option value="">Seleccionar cámara...</option>
        </select>
        <button id="startBtn">Iniciar</button>
        <button id="stopBtn" class="ghost" style="display:none">Detener</button>
      </div>

      <div id="reader"></div>

      <div class="result">
        <div style="flex:1">
          <h3>Resultado</h3>
          <pre id="output">—</pre>
        </div>
        <div class="meta card" style="padding:12px; width:260px;">
          <h4>Estado</h4>
          <small id="lastInfo">Sin escaneos aún</small>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    const output = document.getElementById('output');
    const lastInfo = document.getElementById('lastInfo');

    let html5QrCode = null;

    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices.length) {
          alert("No se encontraron cámaras.");
          return;
        }
        cameraSelect.innerHTML = "";
        devices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.label || `Cámara ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(opt);
        });
      } catch (e) {
        alert("Error obteniendo cámaras: " + e);
      }
    }

    async function startCamera() {
      const cameraId = cameraSelect.value;
      if (!cameraId) {
        alert("Selecciona una cámara primero.");
        return;
      }
      html5QrCode = new Html5Qrcode("reader");
      try {
        await html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 300 },
          (decodedText, decodedResult) => {
            output.textContent = decodedText;
            lastInfo.textContent = `Escaneado a las ${new Date().toLocaleTimeString()}`;
            console.log("QR:", decodedText);
          }
        );
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
      } catch (err) {
        alert("Error al iniciar cámara: " + err);
      }
    }

    async function stopCamera() {
      if (!html5QrCode) return;
      try {
        await html5QrCode.stop();
      } catch {}
      html5QrCode.clear();
      html5QrCode = null;
      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      lastInfo.textContent = "Cámara detenida";
    }

    startBtn.onclick = startCamera;
    stopBtn.onclick = stopCamera;
    window.onload = loadCameras;
  </script>
</body>
</html>
